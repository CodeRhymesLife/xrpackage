<!doctype html>
<html>

<head>
  <title>xrpackage | login</title>
  <link rel=icon type="image/png" href="favicon.png">
  <link href="index.css" rel=stylesheet>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/0735724151.js" crossorigin="anonymous"></script>
</head>

<body class="header-gap">
  <header class=header id=header>
    <a href="/" class="nav icon">å±±</a>
    <nav class="selector nav bar" id=selector>
      <i class="fa fa-user head"></i>
      <div class=header-label id=header-label>Log in</div>
      <i class="fa fa-chevron-down tail"></i>
      <div class=selections id=selections>
        <a href="run.html" class=selection id=run-mode>
          <i class="fa fa-play"></i>
          <div class=wrap>
            <h3>Run mode</h3>
            <p>Switch to run mode</p>
          </div>
        </a>
        <a href="edit.html" class=selection id=edit-mode>
          <i class="fa fa-pencil"></i>
          <div class=wrap>
            <h3>Edit mode</h3>
            <p>You are currently editing this world</p>
          </div>
        </a>
        <a href="browse.html" class="selection dim">
          <i class="fa fa-solar-system"></i>
          <div class=wrap>
            <h3>Browse packages</h3>
            <p>Explore the XRPackage registry</p>
          </div>
        </a>
        <a href="help.html" class=selection>
          <i class="fa fa-book"></i>
          <div class=wrap>
            <h3>Documentation</h3>
            <p>Learn how to make packages and worlds</p>
          </div>
        </a>
      </div>
    </nav>

    <form class="login-form phase-1" id=login-form>
      <div class=phase-content>
        <div class=login-notice id=login-notice></div>
        <div class=login-error id=login-error></div>
      </div>
      <div class="phase-content phase-1-content">
        <input type=email placeholder="your@email.com" id=login-email>
        <input type=submit value="Log in" class="button highlight">
      </div>
      <div class="phase-content phase-2-content">
        <input type=text placeholder="Verification code" id=login-verification-code>
        <input type=submit value="Verify" class="button highlight">
      </div>
      <div class="phase-content phase-3-content">
        <nav class=user-button id=user-button>
          <img src="favicon.ico">
          <span class=name id=login-email-static></span>
          <input type=submit value="Log out" class="button highlight">
        </nav>
      </div>
      <div class="phase-content phaseless-content">
        <div>Working...</div>
      </div>
    </form>
  </header>

<script type=module>
import './selector.js';
import {XRPackageEngine} from './xrpackage.js';

const loginEndpoint = 'https://login.exokit.org';

function parseQuery(queryString) {
  var query = {};
  var pairs = (queryString[0] === '?' ? queryString.substr(1) : queryString).split('&');
  for (var i = 0; i < pairs.length; i++) {
    var pair = pairs[i].split('=');
    query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
  }
  return query;
}

const storage = {
  async get(k) {
    const res = await fetch(`/xrpackage/storage/${k}`);
    if (res.status >= 200 && res.status < 300) {
      const s = await res.text();
      return JSON.parse(s);
    } else {
      return undefined;
    }
  },
  async set(k, v) {
    const res = await fetch(`/xrpackage/storage/${k}`, {
      method: 'PUT',
      body: JSON.stringify(v),
    });
    if (res.status >= 200 && res.status < 300) {
      // nothing
    } else {
      throw new Error(`invalid status code: ${res.status}`);
    }
  },
  async remove(k) {
    const res = await fetch(`/xrpackage/storage/${k}`, {
      method: 'DELETE',
    });
    if (res.status >= 200 && res.status < 300) {
      // nothing
    } else {
      throw new Error(`invalid status code: ${res.status}`);
    }
  },
};
let loginToken = null;
async function doLogin(email, code) {
  const res = await fetch(loginEndpoint + `?email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`, {
    method: 'POST',
  });
  if (res.status >= 200 && res.status < 300) {
    const newLoginToken = await res.json();

    await storage.set('loginToken', newLoginToken);

    loginToken = newLoginToken;

    loginEmailStatic.innerText = loginToken.email;
    /* loginNameStatic.innerText = loginToken.name;
    loginEmailStatic.innerText = loginToken.email;
    if (loginToken.stripeConnectState) {
      statusConnected.classList.add('open');
      statusNotConnected.classList.remove('open');
      connectStripeButton.classList.remove('visible');
    } else {
      statusNotConnected.classList.add('open');
      statusConnected.classList.remove('open');
      connectStripeButton.classList.add('visible');
    } */

    document.body.classList.add('logged-in');
    loginForm.classList.remove('phase-1');
    loginForm.classList.remove('phase-2');
    loginForm.classList.add('phase-3');

    return true;
  } else {
    return false;
  }
}

const loginForm = document.getElementById('login-form');
const loginEmail = document.getElementById('login-email');
const loginVerificationCode = document.getElementById('login-verification-code');
const loginNotice = document.getElementById('login-notice');
const loginError = document.getElementById('login-error');
const loginEmailStatic = document.getElementById('login-email-static');
loginForm.addEventListener('submit', async e => {
  e.preventDefault();

  if (loginForm.classList.contains('phase-1') && loginEmail.value) {
    loginNotice.innerHTML = '';
    loginError.innerHTML = '';
    loginForm.classList.remove('phase-1');

    const res = await fetch(loginEndpoint + `?email=${encodeURIComponent(loginEmail.value)}`, {
      method: 'POST',
    })
    if (res.status >= 200 && res.status < 300) {
      loginNotice.innerText = `Code sent to ${loginEmail.value}!`;
      loginForm.classList.add('phase-2');

      return res.blob();
    } else {
      throw new Error(`invalid status code: ${res.status}`);
    }
 } else if (loginForm.classList.contains('phase-2') && loginEmail.value && loginVerificationCode.value) {
    loginNotice.innerHTML = '';
    loginError.innerHTML = '';
    loginForm.classList.remove('phase-2');

    if (await doLogin(loginEmail.value, loginVerificationCode.value)) {
      xrEngine.postMessage({
        method: 'login',
        loginToken,
      });
    }
  } else if (loginForm.classList.contains('phase-3')) {
    await storage.remove('loginToken');

    window.location.reload();
  }
});

(async () => {
  await XRPackageEngine.waitForLoad();

  const q = parseQuery(window.location.search);
  const {email, code} = q;
  if (email && code && await doLogin(email, code)) {
    delete q.email;
    delete q.code;
    window.location.search = '?' + Object.keys(q).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(q[k])).join('&');
  } else {
    const localLoginToken = await storage.get('loginToken');
    if (localLoginToken) {
      const res = await fetch(loginEndpoint + `?email=${encodeURIComponent(localLoginToken.email)}&token=${encodeURIComponent(localLoginToken.token)}`, {
        method: 'POST',
      })
      if (res.status >= 200 && res.status < 300) {
        loginToken = await res.json();

        await storage.set('loginToken', loginToken);

        loginEmailStatic.innerText = loginToken.email;
        /* loginNameStatic.innerText = loginToken.name;
        loginEmailStatic.innerText = loginToken.email;
        if (loginToken.stripeConnectState) {
          statusConnected.classList.add('open');
          statusNotConnected.classList.remove('open');
          connectStripeButton.classList.remove('visible');
        } else {
          statusNotConnected.classList.add('open');
          statusConnected.classList.remove('open');
          connectStripeButton.classList.add('visible');
        } */

        document.body.classList.add('logged-in');
        loginForm.classList.remove('phase-1');
        loginForm.classList.remove('phase-2');
        loginForm.classList.add('phase-3');
      } else {
        await storage.remove('loginToken');

        console.warn(`invalid status code: ${res.status}`);
      }
    }
  }
})();

</script>
</body>

</html>