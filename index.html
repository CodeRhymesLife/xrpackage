<!doctype html>
<html>
<head>
<style>
body {
  margin: 0;
}
canvas {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
}
.buttons {
  display: flex;
  position: absolute;
  right: 30px;
  bottom: 30px;
  z-index: 1;
}
</style>
</head>
<body>
<div class=buttons>
  <input type=button id=enter-vr-button value="Enter XR">
</div>
<script type=module>
import * as THREE from './three.module.js';
import 'https://rawcdn.githack.com/exokitxr/webpackage/655f2378d91a0496b09b1ce1a820d3fc6243cdc2/dist/wbn.js';
import {RealityScriptEngine, RealityScript} from './reality-script.js';

(async () => {

const res = await fetch('cube.html');
const cubeHtml = await res.text();

const b = RealityScript.compile(
  'https://realityscript.com/',
  'https://realityscript.com/manifest.json',
  [
    {
      url: 'https://realityscript.com/',
      type: 'text/html',
      data: cubeHtml,
    }
  ]
);
const rs = new RealityScript(b);

const rse = new RealityScriptEngine();
rse.add(rs);

/* const canvas = document.createElement('canvas');
const context = canvas.getContext('webgl', {
  antialias: true,
  alpha: true,
  preserveDrawingBuffer: false,
}); */
const renderer = new THREE.WebGLRenderer({
  canvas: rse.domElement,
  context: rse.context,
  antialias: true,
  alpha: true,
  // preserveDrawingBuffer: true,
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
// renderer.autoClear = false;
renderer.sortObjects = false;
renderer.physicallyCorrectLights = true;
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 0, 1);

const ambientLight = new THREE.AmbientLight(0xFFFFFF);
scene.add(ambientLight);
const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 3);
scene.add(directionalLight);
const directionalLight2 = new THREE.DirectionalLight(0xFFFFFF, 3);
scene.add(directionalLight2);

const cubeMesh = (() => {
  const geometry = new THREE.BoxBufferGeometry(0.1, 0.1, 0.1);
  const material = new THREE.MeshStandardMaterial({
    color: 0xFF0000,
    side: THREE.DoubleSide,
  });
  const mesh = new THREE.Mesh(geometry, material);  
  mesh.frustumCulled = false;
  return mesh;
})();
// cubeMesh.position.set(0, 0.1, 0);
cubeMesh.rotation.order = 'YXZ';
scene.add(cubeMesh);

function animate(timestamp, frame) {
  renderer.state.reset();

  const f = (Date.now()%2000)/2000 * Math.PI*2;
  cubeMesh.rotation.x = f;
  cubeMesh.rotation.y = f;
  cubeMesh.rotation.z = f;

  if (!currentSession) {
    const gl = renderer.getContext();
    gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    const viewport = renderer.getCurrentViewport(new THREE.Vector4());
    rse.context.viewport(viewport.x, viewport.y, viewport.z, viewport.w);
  }
  renderer.render(scene, camera);

  rse.tick(timestamp, frame);
}
renderer.setAnimationLoop(animate);

let currentSession = null;
function onSessionStarted(session) {
  session.addEventListener('end', onSessionEnded);
  
  currentSession = session;

  renderer.xr.setSession(session);
  rse.setSession(session);
}
function onSessionEnded() {
  currentSession.removeEventListener('end', onSessionEnded);

  currentSession = null;

  renderer.xr.setSession(null);
  rse.setSession(null);
}

document.getElementById('enter-vr-button').addEventListener('click', e => {
  e.preventDefault();
  e.stopPropagation();
  
  if (currentSession === null) {
    navigator.xr.requestSession('immersive-vr', {
      optionalFeatures: [
        'local-floor',
        'bounded-floor',
      ],
    }).then(onSessionStarted);
  } else {
    currentSession.end();
  }
});

})();
</script>
</body>
</html>