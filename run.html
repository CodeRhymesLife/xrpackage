<!doctype html>
<html>

<head>
  <title>xrpackage | run</title>
  <link href="index.css" rel=stylesheet>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/0735724151.js" crossorigin="anonymous"></script>
  <script
    src="https://rawcdn.githack.com/ethereum/web3.js/a6ddec59e65116853435f203b25cb9c55824d084/dist/web3.min.js"></script>
</head>

<body>
  <header class=header id=header>
    <a href="/" class="nav icon">メマアムく匕ムウヨ</a>
    <nav class="nav double open">
      <a href="/scenes.html"><i class="fa fa-chevron-left"></i></a>
      Run
    </nav>
    <a href="/edit.html" class="nav full">
      <i class="fa fa-pencil"></i>
      <span>Edit</span>
    </a>

    <div class="buttons right">
      <nav class=button id=enter-xr-button>Enter XR</nav>
    </div>
  </header>
<script type=module>
  import THREE from './three.module.js';
  window.THREE = THREE;
</script>
<script type="module" src="run.js"></script>
<script type="module">
(async () => {
  const q = parseQuery(window.location.search);
  if (q.i) {
    const metadataHash = await contract.methods.getMetadata(parseInt(q.i, 10), 'hash').call();
    const metadata = await fetch(`${apiHost}/${metadataHash}`)
      .then(res => res.json());
    const {dataHash} = metadata;

    const arrayBuffer = await fetch(`${apiHost}/${dataHash}.wbn`)
      .then(res => res.arrayBuffer());

    const p = new XRPackage(new Uint8Array(arrayBuffer));
    await pe.add(p);
  } else if (q.u) {
    const arrayBuffer = await fetch(q.u)
      .then(res => res.arrayBuffer());

    const p = new XRPackage(new Uint8Array(arrayBuffer));
    await pe.add(p);
  } else if (q.h) {
    const [cubeHtml, cubeManifest] = await Promise.all([
      (async () => {
        const res = await fetch('examples/html/cube.html');
        return await res.text();
      })(),
      (async () => {
        const res = await fetch('examples/html/manifest.json');
        return await res.text();
      })(),
    ]);

    const d = XRPackage.compileRaw(
      [
        {
          url: '/cube.html',
          type: 'text/html',
          data: cubeHtml,
        },
        {
          url: '/manifest.json',
          type: 'application/json',
          data: cubeManifest,
        }
      ]
    );
    const p = new XRPackage(d);
    await pe.add(p);
  } else {
    const [cubeHtml, cubeManifest, modelVrm, catVox] = await Promise.all([
      (async () => {
        const res = await fetch('examples/html/cube.html');
        return await res.text();
      })(),
      (async () => {
        const res = await fetch('examples/html/manifest.json');
        return await res.text();
      })(),
      (async () => {
        const res = await fetch('examples/vrm/model.vrm');
        return await res.arrayBuffer();
      })(),
      (async () => {
        const res = await fetch('examples/vox/cat.vox');
        return await res.arrayBuffer();
      })(),
    ]);

    {
      const d = XRPackage.compileRaw(
        [
          {
            url: '/cube.html',
            type: 'text/html',
            data: cubeHtml,
          },
          {
            url: '/manifest.json',
            type: 'application/json',
            data: cubeManifest,
          }
        ]
      );
      const p = new XRPackage(d);
      await pe.add(p);
    }
    {
      const d = XRPackage.compileRaw(
        [
          {
            url: '/model.vrm',
            type: 'application/octet-stream',
            data: new Uint8Array(modelVrm),
          },
          {
            url: '/manifest.json',
            type: 'application/json',
            data: JSON.stringify({
              name: 'Avatar',
              xr_type: 'vrm@0.0.1',
              start_url: 'model.vrm',
            }),
          }
        ]
      );
      const p = new XRPackage(d);
      await pe.add(p);
    }
    {
      const d = XRPackage.compileRaw(
        [
          {
            url: '/cat.vox',
            type: 'application/octet-stream',
            data: new Uint8Array(catVox),
          },
          {
            url: '/manifest.json',
            type: 'application/json',
            data: JSON.stringify({
              name: 'Cat',
              xr_type: 'vox@0.0.1',
              start_url: 'cat.vox',
            }),
          }
        ]
      );
      const p = new XRPackage(d);
      await pe.add(p);
    }
  }
})();
</script>
</body>

</html>